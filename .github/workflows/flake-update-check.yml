name: Flake Update Check

on:
  schedule:
    # Run weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
  push:
    branches:
      - flake-update/*
    paths:
      - 'flake.nix'
      - 'flake.lock'

jobs:
  check-flake-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            
      - name: Check for flake updates
        id: check-updates
        run: |
          # Extract nixpkgs ref from flake.nix with better parsing
          NIXPKGS_REF=$(grep 'inputs.nixpkgs.url' flake.nix | sed 's/.*github:NixOS\/nixpkgs\/\([^"]*\).*/\1/')
          
          # Fallback to default if parsing fails
          if [ -z "$NIXPKGS_REF" ]; then
            NIXPKGS_REF="nixos-unstable"
          fi
          
          echo "Extracted nixpkgs ref: $NIXPKGS_REF"
          
          # Get current and latest revisions
          CURRENT_REV=$(nix flake metadata --json 2>/dev/null | jq -r '.locks.nodes.nixpkgs.locked.rev')
          LATEST_REV=$(curl -s "https://api.github.com/repos/NixOS/nixpkgs/commits/$NIXPKGS_REF" | jq -r '.sha // empty')
          
          echo "Current revision: $CURRENT_REV"
          echo "Latest revision: $LATEST_REV"
          
          # Check if we got valid responses
          if [ -z "$CURRENT_REV" ] || [ "$CURRENT_REV" = "null" ]; then
            echo "Failed to get current revision"
            exit 1
          fi
          
          if [ -z "$LATEST_REV" ] || [ "$LATEST_REV" = "null" ]; then
            echo "Failed to get latest revision for ref: $NIXPKGS_REF"
            exit 1
          fi
          
          if [ "$CURRENT_REV" = "$LATEST_REV" ]; then
            echo "flake_status=success" >> $GITHUB_ENV
            echo "status_text=up to date" >> $GITHUB_ENV
            echo "up_to_date=true" >> $GITHUB_ENV
            echo "✅ Flake.lock is up to date"
          else
            echo "flake_status=failure" >> $GITHUB_ENV
            echo "status_text=out to date" >> $GITHUB_ENV
            echo "up_to_date=false" >> $GITHUB_ENV
            echo "❌ Flake.lock is outdated"
          fi
          
      - name: Update badge status
        if: always()
        run: |
          # Create badge using shields.io dynamic endpoint
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{
              \"state\": \"${{ env.flake_status }}\",
              \"target_url\": \"https://github.com/${{ github.repository }}/actions\",
              \"description\": \"flake.lock is ${{ env.status_text }}\",
              \"context\": \"flake.lock\"
            }" || echo "Status update failed"

  auto-update-flake:
    needs: check-flake-updates
    if: needs.check-flake-updates.outputs.up_to_date == 'false'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
        
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            access-tokens = github.com=${{ secrets.GITHUB_TOKEN }}
            
      - name: Update flake.lock
        run: |
          nix flake update
        
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update flake.lock"
          branch: flake-update/auto-update
          title: "Update flake.lock"
          body: |
            Automated update of `flake.lock`.
            
            Auto-generated by [flake-update workflow](https://github.com/${{ github.repository }}/actions/workflows/flake-update-check.yml).
          delete-branch: true