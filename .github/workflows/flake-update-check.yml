name: Flake Update Check

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  check-flake-updates:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          extra_nix_config: |
            experimental-features = nix-command flakes
            
      - name: Check for flake updates
        id: check-updates
        run: |
          # Extract nixpkgs ref from flake.nix with better parsing
          NIXPKGS_REF=$(grep 'inputs.nixpkgs.url' flake.nix | sed 's/.*github:NixOS\/nixpkgs\/\([^"]*\).*/\1/')
          
          # Fallback to default if parsing fails
          if [ -z "$NIXPKGS_REF" ]; then
            NIXPKGS_REF="nixos-25.11"
          fi
          
          echo "Extracted nixpkgs ref: $NIXPKGS_REF"
          
          # Get current and latest revisions
          CURRENT_REV=$(nix flake metadata --json | jq -r '.locks.nodes.nixpkgs.locked.rev')
          LATEST_REV=$(curl -s "https://api.github.com/repos/NixOS/nixpkgs/commits/$NIXPKGS_REF" | jq -r '.sha')
          
          echo "Current revision: $CURRENT_REV"
          echo "Latest revision: $LATEST_REV"
          
          # Check if we got valid responses
          if [ -z "$CURRENT_REV" ] || [ "$CURRENT_REV" = "null" ]; then
            echo "Failed to get current revision"
            exit 1
          fi
          
          if [ -z "$LATEST_REV" ] || [ "$LATEST_REV" = "null" ]; then
            echo "Failed to get latest revision for ref: $NIXPKGS_REF"
            exit 1
          fi
          
          if [ "$CURRENT_REV" = "$LATEST_REV" ]; then
            echo "flake_status=success" >> $GITHUB_ENV
            echo "status_text=up to date" >> $GITHUB_ENV
            echo "color=brightgreen" >> $GITHUB_ENV
            echo "✅ Flake.lock is up to date"
          else
            echo "flake_status=failure" >> $GITHUB_ENV
            echo "status_text=outdated" >> $GITHUB_ENV
            echo "color=red" >> $GITHUB_ENV
            echo "❌ Flake.lock is outdated"
          fi
          
      - name: Update badge status
        if: always()
        run: |
          # Create badge using shields.io dynamic endpoint
          curl -X POST \
            -H "Accept: application/vnd.github.v3+json" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            https://api.github.com/repos/${{ github.repository }}/statuses/${{ github.sha }} \
            -d "{
              \"state\": \"${{ env.flake_status }}\",
              \"target_url\": \"https://github.com/${{ github.repository }}/actions\",
              \"description\": \"flake.lock is ${{ env.status_text }}\",
              \"context\": \"flake.lock\"
            }" || echo "Status update failed"